events {
    worker_connections 128;
}

http {
    # 1. LOAD BALANCING FOR PET-ORDER ONLY (Requirement: 3:1 Ratio)
    upstream pet-order-service {
        server pet-order1:8080 weight=3;
        server pet-order2:8080 weight=1;
    }

    # 2. Upstreams for Pet Stores
    upstream pet-store1 {
        server pet-store1:8000;
    }

    upstream pet-store2 {
        server pet-store2:8000;
    }

    server {
        listen 80;

        location /pet-types1 {
            # Note: The trailing slash ensures /pet-types1/123 becomes /pet-types/123
            proxy_pass http://pet-store1/pet-types;
            limit_except GET {
                deny all;
            }
        }

        # --- STORE 2 ROUTES ---
        # Maps /pet-types2 -> /pet-types on the backend
        location /pet-types2 {
            proxy_pass http://pet-store2/pet-types;
            limit_except GET {
                deny all;
            }
        }

        # --- ORDER SERVICE ROUTES ---
        # Maps /purchases -> /purchases on the backend
        location /purchases {
            # Note: No trailing slash here lets NGINX pass the path as-is
            proxy_pass http://pet-order-service;
            
            # Requirement: Only POST requests allowed for purchases
            limit_except POST {
                deny all;
            }
        }
    }
}